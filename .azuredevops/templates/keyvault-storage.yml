parameters:
  - name: azureSubscription
    type: string
    default: 'Azure Subscription'
  - name: keyVaultName
    type: string
  - name: secretName
    type: string
  - name: secretValue
    type: string
  - name: resourceGroupName
    type: string
steps:
  - task: AzureCLI@2
    displayName: 'Store Secret in Key Vault'
    inputs:
      azureSubscription: ${{ parameters.azureSubscription }}
      scriptType: bash
      scriptLocation: inlineScript
      inlineScript: |
        # Check if Key Vault exists
        echo "Checking if Key Vault '${{ parameters.keyVaultName }}' exists..."
        
        if az keyvault show --name ${{ parameters.keyVaultName }} --resource-group ${{ parameters.resourceGroupName }} >/dev/null 2>&1; then
          echo "Key Vault exists, storing secret..."
          
          # Store the secret in Key Vault
          az keyvault secret set \
            --vault-name ${{ parameters.keyVaultName }} \
            --name ${{ parameters.secretName }} \
            --value "${{ parameters.secretValue}}" \
            --output none
            
          echo "✅ Secret '${{ parameters.secretName }}' stored successfully in Key Vault"
          
          # Get the secret URL for reference
          SECRET_URL=$(az keyvault secret show \
            --vault-name ${{ parameters.keyVaultName }} \
            --name ${{ parameters.secretName }} \
            --query id \
            --output tsv)
          
          echo "Secret URL: $SECRET_URL"
          
        else
          echo "❌ Key Vault '${{ parameters.keyVaultName }}' not found in resource group '${{ parameters.resourceGroupName }}'"
          echo "Creating Key Vault..."
          
          # Create Key Vault with soft delete enabled
          az keyvault create \
            --name ${{ parameters.keyVaultName }} \
            --resource-group ${{ parameters.resourceGroupName }} \
            --location $(az group show --name ${{ parameters.resourceGroupName }} --query location --output tsv) \
            --enable-soft-delete true \
            --soft-delete-retention-in-days 7 \
            --enable-purge-protection false \
            --sku standard \
            --output none
            
          echo "✅ Key Vault '${{ parameters.keyVaultName }}' created successfully"
          
          # Store the secret
          az keyvault secret set \
            --vault-name ${{ parameters.keyVaultName }} \
            --name ${{ parameters.secretName }} \
            --value "${{ parameters.secretValue}}" \
            --output none
            
          echo "✅ Secret '${{ parameters.secretName }}' stored successfully in Key Vault"
          
          # Get the secret URL for reference
          SECRET_URL=$(az keyvault secret show \
            --vault-name ${{ parameters.keyVaultName }} \
            --name ${{ parameters.secretName }} \
            --query id \
            --output tsv)
          
          echo "Secret URL: $SECRET_URL"
        fi 