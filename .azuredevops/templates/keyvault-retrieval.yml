parameters:
  - name: azureSubscription
    type: string
    default: 'Azure Subscription'
  - name: keyVaultName
    type: string
  - name: secretName
    type: string
  - name: outputVariableName
    type: string
    default: 'retrievedSecret'
steps:
  - task: AzureCLI@2
    displayName: 'Retrieve Secret from Key Vault'
    inputs:
      azureSubscription: ${{ parameters.azureSubscription }}
      scriptType: bash
      scriptLocation: inlineScript
      inlineScript: |
        # Retrieve secret from Key Vault
        echo "Retrieving secret '${{ parameters.secretName }}' from Key Vault '${{ parameters.keyVaultName }}'..."
        
        # Get the secret value
        SECRET_VALUE=$(az keyvault secret show \
          --vault-name ${{ parameters.keyVaultName }} \
          --name ${{ parameters.secretName }} \
          --query value \
          --output tsv)
        
        if [ $? -eq 0 ]; then
          echo "✅ Secret retrieved successfully"
          
          # Set as pipeline variable
          echo "##vso[task.setvariable variable=${{ parameters.outputVariableName }};isSecret=true]$SECRET_VALUE"
          
          echo "Secret value set as pipeline variable: ${{ parameters.outputVariableName }}"
        else
          echo "❌ Failed to retrieve secret '${{ parameters.secretName }}' from Key Vault '${{ parameters.keyVaultName }}'"
          exit 1
        fi 